<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Queue Dashboard</title>
    <style>
        /* (CSS styles remain the same) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { font-size: 1.1em; opacity: 0.9; }
        .dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.8em; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .add-patient-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input[type="text"], select, input[type="number"] { flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border 0.3s; }
        button { padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .queue-list { max-height: 500px; overflow-y: auto; }
        .patient-item { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .patient-name { font-size: 1.2em; font-weight: 600; color: #333; margin-bottom: 5px; }
        .patient-details { display: flex; gap: 15px; font-size: 0.9em; color: #666; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; color: white; }
        .badge.position { background: #4CAF50; }
        .badge.wait-time { background: #FF9800; }
        .badge.severity { background: #E91E63; } /* NEW STYLE */
        .badge.type-emergency { background: #f44336; }
        .badge.type-appointment { background: #2196F3; }
        .badge.type-walk-in { background: #FFC107; color: #333; }
        .btn-complete { background: #4CAF50; padding: 8px 15px; font-size: 0.9em; border: none; }
        .system-status { background: white; border-radius: 10px; padding: 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .recognition-card { background: #f8f9fa; padding: 20px; border-radius: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .patient-data-item { margin-bottom: 8px; font-size: 1.1em; }
        .patient-data-item strong { display: inline-block; min-width: 120px; color: #333; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Intelligent Queue Management System</h1>
            <p class="subtitle">Real-time patient queue monitoring & management</p>
        </header>

        <div class="system-status">
            <strong>System Status:</strong> <span id="systemStatus">Loading...</span>
        </div>

        <br>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalPatients">0</div>
                <div class="stat-label">Patients in Queue</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgWaitTime">0</div>
                <div class="stat-label">Avg Wait Time (min)</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="completedToday">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>Current Queue</h2>
                
                <div class="add-patient-form">
                    <input type="text" id="patientName" placeholder="Enter patient name..." />
                    <select id="patientType">
                        <option value="walk-in">Walk-in (Default)</option>
                        <option value="appointment">Appointment</option>
                        <option value="emergency">Emergency</option>
                    </select>
                    <input type="number" id="patientSeverity" placeholder="Severity Score (1-10, 10 is max)" min="1" max="10" value="5" /> 
                    
                    <button onclick="addPatient()">Add Patient to Queue</button>
                    
                    <hr style="margin: 10px 0;">
                    
                    <input type="text" id="recognitionName" placeholder="Simulated Recognized Name" />
                    <button onclick="simulateRecognitionCheck()">Simulate Face Scan</button>
                    <button style="background: #28a745;" onclick="addRecognizedPatient()">Check-In/Add New</button>
                </div>

                <div class="queue-list" id="queueList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Loading queue data...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Completed Patients</h2>
                <div class="queue-list" id="historyList">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p>No completed patients yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // --- FETCH DATA AND REFRESH ---
        async function fetchQueueData() {
            try {
                const response = await fetch(`${API_BASE}/queue`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateDashboard(data.queue, data.history, data.stats);
                document.getElementById('systemStatus').textContent = 'Active (Last Sync: ' + new Date().toLocaleTimeString() + ')';
            } catch (error) {
                console.error("Failed to fetch queue data:", error);
                document.getElementById('systemStatus').textContent = 'Error: Cannot connect to server!';
            }
        }

        // --- ACTIONS - MODIFIED ---
        async function addPatient() {
            const nameInput = document.getElementById('patientName');
            const typeSelect = document.getElementById('patientType');
            const severityInput = document.getElementById('patientSeverity'); // NEW
            
            const name = nameInput.value.trim();
            const type = typeSelect.value;
            const severity = parseInt(severityInput.value) || 5; // NEW: Get severity, default to 5
            
            if (!name) {
                alert("Please enter a patient name.");
                return;
            }

            await fetch(`${API_BASE}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Include severity in the JSON body
                body: JSON.stringify({ name: name, type: type, severity: severity }) 
            });
            
            nameInput.value = '';
            // Reset severity to a default value after submission
            severityInput.value = '5'; 
            fetchQueueData(); // Refresh the list
        }

        async function addRecognizedPatient() {
            const nameInput = document.getElementById('recognitionName');
            let name = nameInput.value.trim();
            let type = 'walk-in'; 
            let severity = 5; // Default severity

            if (!name) {
                name = `NEW PATIENT ${Math.floor(Math.random() * 1000)}`;
                type = 'walk-in';
                severity = 5;
            } else {
                // Assume recognized patients often have appointments/higher priority due to pre-screening
                type = 'appointment'; 
                severity = 7; // Assign slightly higher severity for recognized/check-in patients
            }

            await fetch(`${API_BASE}/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Include severity
                body: JSON.stringify({ name: name, type: type, severity: severity })
            });

            nameInput.value = '';
            fetchQueueData();
        }

        async function markDone(patientId) {
            await fetch(`${API_BASE}/done/${patientId}`, {
                method: 'POST'
            });
            fetchQueueData(); // Refresh the list
        }
        
        // --- SIMULATION ---
        const MOCK_DB = ["John Doe (Appt)", "Jane Smith (Walk-in)", "Aisha Khan (Emergency)"];
        function simulateRecognitionCheck() {
            const nameInput = document.getElementById('recognitionName');
            const recognized = Math.random() < 0.7; 

            if (recognized) {
                const match = MOCK_DB[Math.floor(Math.random() * MOCK_DB.length)];
                nameInput.value = match;
            } else {
                nameInput.value = ""; 
                alert("Face not recognized. Use the 'Check-In/Add New' button to register as a new patient.");
            }
        }

        // --- DASHBOARD RENDERING (Using data from the API) - MODIFIED ---
        function updateDashboard(queue, history, stats) {
            // 1. Update Stats
            document.getElementById('totalPatients').textContent = stats.totalPatients;
            document.getElementById('avgWaitTime').textContent = stats.avgWaitTime;
            document.getElementById('completedToday').textContent = stats.completedToday;

            // 2. Update Queue List
            const queueList = document.getElementById('queueList');
            if (queue.length === 0) {
                queueList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No patients in queue</p></div>`;
            } else {
                queueList.innerHTML = queue.map(patient => `
                    <div class="patient-item">
                        <div class="patient-info">
                            <div class="patient-name">${patient.name}</div>
                            <div class="patient-details">
                                <span><span class="badge position">Pos: ${queue.indexOf(patient) + 1}</span></span>
                                <span><span class="badge type-${patient.type.toLowerCase()}">${patient.type}</span></span>
                                <span><span class="badge severity">Severity: ${patient.severity_score}</span></span> <span><span class="badge wait-time">Wait: ${patient.estimated_wait_min} min</span></span>
                                <span>Arrived: ${patient.arrival_time}</span>
                            </div>
                        </div>
                        <div class="patient-actions">
                            <button class="btn-complete" onclick="markDone('${patient.id}')">Complete</button>
                        </div>
                    </div>
                `).join('');
            }

            // 3. Update History List
            const historyList = document.getElementById('historyList');
            if (history.length === 0) {
                historyList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No completed patients yet</p></div>`;
            } else {
                historyList.innerHTML = history.map(patient => `
                    <div class="history-item">
                        <strong>${patient.name}</strong> - Completed at ${patient.completion_time}
                        <br>
                        <small>Arrived: ${patient.arrival_time} | Type: ${patient.type}</small>
                    </div>
                `).join('');
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initial fetch and set interval for constant updates
            fetchQueueData();
            // Refreshes the queue every 5 seconds (5000 milliseconds)
            setInterval(fetchQueueData, 5000); 
        });
    </script>
</body>
</html>